{# Recursive tree node macro #}
{% macro render_node(node, depth=0) %}
<div class="tree-node" data-id="{{ node.id }}" data-status="{{ node.status }}" data-depth="{{ depth }}" tabindex="0">
  <div class="tree-row">
    <span class="tree-indent" style="width:{{ depth * 20 }}px"></span>
    {% if node.children %}
      <button class="tree-toggle" onclick="event.stopPropagation(); toggleNode('{{ node.id }}')" aria-label="toggle">&#x25B8;</button>
    {% else %}
      <span class="tree-toggle-spacer"></span>
    {% endif %}
    {% if node.status == "closed" %}
      {% if node.outcome == "failure" %}
        <span class="tree-status tree-status-failure">&#x2715;</span>
      {% elif node.outcome == "expanded" %}
        <span class="tree-status tree-status-expanded">&#x25CB;</span>
      {% elif node.outcome == "skipped" %}
        <span class="tree-status tree-status-skipped">&#x2013;</span>
      {% else %}
        <span class="tree-status tree-status-success">&#x2713;</span>
      {% endif %}
    {% elif node.status == "in_progress" %}
      <span class="tree-status tree-status-active">&#x25CF;</span>
    {% else %}
      <span class="tree-status tree-status-open">&#x25CB;</span>
    {% endif %}
    <span class="tree-title">{{ node.title }}</span>
    <span class="tree-meta">
      {% if node.priority is defined and node.priority != 3 %}
        <span class="emes-priority priority-{{ node.priority }}">P{{ node.priority }}</span>
      {% endif %}
      {% if node.execution_spec and node.execution_spec.role %}
        <span class="emes-tag emes-tag-sm">{{ node.execution_spec.role }}</span>
      {% endif %}
    </span>
  </div>
  {% if node.children %}
  <div class="tree-children" id="children-{{ node.id }}">
    {% for child in node.children %}
      {{ render_node(child, depth + 1) }}
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endmacro %}
